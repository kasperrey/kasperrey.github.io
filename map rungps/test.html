<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home rungps loader</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Espruino Interface -->
    <script src="interface.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.5/dist/chart.umd.min.js"></script>

    <link rel="stylesheet" href="Home.css">
</head>
<body>
<script src="calculations.js"></script>

<div id="map"></div>
<div id="charts">
    <canvas id="heart_rateChart" class="Chart"></canvas>
    <canvas id="speedChart" class="Chart"></canvas>
    <canvas id="altitudeChart" class="Chart"></canvas>
</div>
<div class="data" id="tooltip">
    <p id="heart_rate">heart rate: 0 bpm</p>
    <p id="speed">speed: 0:0 min/km</p>
    <p id="altitude">altitude: 0m</p>
    <p id="time">time: 0:00:00</p>
</div>
<div class="data">
    <p id="distance">0km</p>
    <p id="averageSpeed">0:0min/km</p>
</div>
<div id="inputDiv">
    <button id="btnConnect">Connect</button>
    <button id="Read">Read</button>
    <label for="input"></label><input id="input">
</div>
<script>
var text = "";
var points = [];
let place;
let xTime;
const groep = new L.featureGroup();
const heart_rateData = document.getElementById("heart_rate");
const speedData = document.getElementById("speed");
const altData = document.getElementById("altitude");
const timeData = document.getElementById("time");

// Show data on map and charts
function show(map, heart_rateChart, speedChart, altChart) {
    points = window.calculations.translateData(text);
    var vorig = points[0];
    L.circle([vorig.lat, vorig.long], { color: 'green', fillColor: '#00ff00', fillOpacity: 1, radius: 2 }).addTo(map);
    L.circle([points[points.length-1].lat, points[points.length-1].long], { color: 'purple', fillColor: '#7300ff', fillOpacity: 1, radius: 2 }).addTo(map);

    for (let i = 1; i < points.length; i++) {
        let point = points[i];
        var pointList = [new L.LatLng(vorig.lat, vorig.long), new L.LatLng(point.lat, point.long)];
        var firstpolyline = new L.Polyline(pointList, { color: 'red', weight: 3, opacity: 0.5, smoothFactor: 1 });
        groep.addLayer(firstpolyline);
        map.addLayer(firstpolyline);

        let time = window.calculations.convertSecondstoTime(point.time);
        if (point.heart_rate) {
            heart_rateChart.data.datasets[0].pointBackgroundColor.push("red");
            heart_rateChart.data.datasets[0].pointRadius.push(1);
            heart_rateChart.data.datasets[0].data.push(point.heart_rate);
            heart_rateChart.data.labels.push(time);
            heart_rateChart.update();
        }
        if (point.speed !== 0) {
            speedChart.data.datasets[0].pointBackgroundColor.push("blue");
            speedChart.data.datasets[0].pointRadius.push(1);
            speedChart.data.datasets[0].data.push(60 / point.speed);
            speedChart.data.labels.push(time);
            speedChart.update();
        }
        if (point.alt) {
            altChart.data.datasets[0].pointBackgroundColor.push("grey");
            altChart.data.datasets[0].pointRadius.push(1);
            altChart.data.datasets[0].data.push(point.alt);
            altChart.data.labels.push(time);
            altChart.update();
        }
        vorig = points[i];
    }

    map.fitBounds(groep.getBounds());
    [document.getElementById("averageSpeed").innerText, document.getElementById("distance").innerText] =
        window.calculations.getAverageSpeedAndDistance(points);
}

// Initialize map
let map = L.map('map').setView([0, 0], 0);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

// Charts initialization (keep your existing configuration)
const heart_rateChart = new Chart(document.getElementById("heart_rateChart").getContext("2d"), { /* ... chart config ... */ });
const speedChart = new Chart(document.getElementById("speedChart").getContext("2d"), { /* ... chart config ... */ });
const altChart = new Chart(document.getElementById("altitudeChart").getContext("2d"), { /* ... chart config ... */ });

// Connect to Espruino via interface.js
function getData() {
    let connection;
    let text = "";

    const btnConnect = document.getElementById("btnConnect");
    const btnRead = document.getElementById("Read");
    const inputField = document.getElementById("input");

    function filterData(data) {
        return data.replace(/[^0-9 ,.\n]/g, "");
    }

    function handleData(d) {
        let l = filterData(d);
        if (d.includes("]")) {
            text += l;
            console.log(text);
            show(map, heart_rateChart, speedChart, altChart);
        } else {
            text += l;
        }
    }

    function listFiles() {
        Espruino.Core.Serial.write(`\x10require("Storage").list(/rungps\\..+\\.csv$/,{sf:1});\n`);
    }

    function connectToEspruino() {
        if (connection) {
            connection.close();
            connection = undefined;
        }
        Espruino.Core.Serial.open(
            c => {
                if (!c) { alert("Couldn't connect!"); return; }
                connection = c;
                connection.on("data", handleData);

                btnRead.addEventListener("click", () => {
                    console.log(inputField.value);
                    listFiles();
                }, { once: true });
            },
            err => alert("Connection failed: " + err)
        );
    }

    btnConnect.addEventListener("click", connectToEspruino);
}

getData();

// Label hover updates
function labelMaker(tooltipData, chart) {
    const labels = tooltipData.dataset.label.toString();
    const values = tooltipData.dataset.data[tooltipData.dataIndex];
    const xLabel = tooltipData.label.toString();
    let index = window.calculations.getIndexByTime(xLabel, points);
    let point = points[index];

    heart_rateData.innerText = "heart rate: "+point.heart_rate+" bpm";
    speedData.innerText = "speed: "+Math.floor(60 / point.speed)+":"+Math.floor(60 / point.speed * 60 % 60)+" min/km";
    altData.innerText = "alt: "+point.alt+"m";
    timeData.innerText = "time: "+window.calculations.convertSecondstoTime(point.time);

    if (place) { place.removeFrom(map); }
    place = L.circle([point.lat, point.long], { color: 'blue', fillColor: '#0000ff', fillOpacity: 1, radius: 1 }).addTo(map);

    xTime = index;
    if (chart !== "heart rate") heart_rateChart.update();
    if (chart !== "speed") speedChart.update();
    if (chart !== "altitude") altChart.update();

    return [values, labels];
}
</script>
</body>

</html>
